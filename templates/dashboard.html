{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: #2a2d3e;
        color: #f0f0f0;
        margin: 0;
        overflow-x: hidden;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 250px;
        background: #1f2233;
        padding-top: 4rem;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.4);
        z-index: 100;
      }

      .sidebar h3 {
        text-align: center;
        margin-bottom: 2rem;
        color: #8896f7;
        font-weight: 700;
      }

      .sidebar a {
        display: block;
        color: #ddd;
        padding: 0.9rem 1.5rem;
        text-decoration: none;
        font-weight: 500;
        transition: 0.3s;
      }

      .sidebar a:hover,
      .sidebar a.active {
        background: #32364a;
        color: #fff;
        border-left: 4px solid #8896f7;
      }

      .main-content {
        margin-left: 250px;
        padding: 2rem;
      }

      .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, #5566ff, #8896f7);
        padding: 1.8rem;
        border-radius: 1rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
        margin-bottom: 2rem;
        color: #fff;
      }

      .dashboard-header img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid #fff;
      }

      .btn-edit {
        background: #ff7b72;
        color: #fff;
        font-weight: 600;
        border-radius: 0.5rem;
        padding: 0.5rem 1.2rem;
        transition: 0.3s ease;
      }

      .btn-edit:hover {
        background: #ff958e;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: #383c50;
        border-radius: 1rem;
        padding: 1.6rem;
        text-align: center;
        color: #fff;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .recent-quizzes {
        background: #383c50;
        border-radius: 1rem;
        padding: 1.6rem;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
      }

      .recent-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      .recent-card:last-child {
        border-bottom: none;
      }

      .badge-score {
        background: linear-gradient(135deg, #5566ff, #8896f7);
        color: #fff;
        padding: 0.4rem 0.9rem;
        border-radius: 0.5rem;
        font-weight: 500;
      }

      .btn-retake {
        background: #ffb84d;
        color: #fff;
        font-weight: 600;
        border: none;
        border-radius: 0.4rem;
        padding: 0.3rem 0.9rem;
      }

      .btn-retake:hover {
        background: #ffc86b;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h3>ðŸ“Š Dashboard</h3>
      <a href="{% url 'dashboard' %}" class="active"
        ><i class="bi bi-house me-2"></i> Home</a
      >
      <a href="#" data-bs-toggle="modal" data-bs-target="#leaderboardModal"
        ><i class="bi bi-trophy me-2"></i> Leaderboard</a
      >
      <a href="{% url 'create_quiz' %}"
        ><i class="bi bi-plus-circle me-2"></i> Create Quiz</a
      >
      <a href="{% url 'logout' %}"
        ><i class="bi bi-box-arrow-right me-2"></i> Logout</a
      >
    </div>

    <div class="main-content">
      {% include "navbar.html" %}

      <div class="dashboard-header">
        <div class="d-flex align-items-center gap-3">
          <img src="{{ user.profile.avatar.url }}" alt="Avatar" />
          <div>
            <h3>Hello, {{ profile.user }}</h3>
            <p>{{ user.profile.bio|default:"No bio added yet" }}</p>
          </div>
        </div>
        <button
          class="btn btn-edit"
          data-bs-toggle="modal"
          data-bs-target="#profilemodal"
        >
          <i class="bi bi-pencil-square me-1"></i> Edit Profile
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <i class="bi bi-trophy-fill fs-3"></i>
          <h4>{{ total_score }}</h4>
          <p>Total Score</p>
        </div>
        <div class="stat-card">
          <i class="bi bi-journal-check fs-3"></i>
          <h4>{{ total_quizzes }}</h4>
          <p>Quizzes Attempted</p>
        </div>
        <div class="stat-card">
          <i class="bi bi-graph-up fs-3"></i>
          <h4>{{ avg_score }}</h4>
          <p>Average Score</p>
        </div>
      </div>

      <div class="recent-quizzes">
        <h4 class="text-info fw-bold mb-3"> Recent Quizzes</h4>
        {% for attempt in recent_quizzes %}
        <div class="recent-card">
          <div>
            <strong>{{ attempt.quiz.title }}</strong>
            <small>{{ attempt.completed_at|date:"M d, Y H:i" }}</small>
          </div>

          {% if attempt.completed_at %}
          <span class="badge-score">{{ attempt.score }} pts</span>
          {% else %}
          <a
            href="{% url 'resume_quiz' attempt.quiz.id %}"
            class="btn btn-sm btn-danger"
          >
            <i class="bi bi-arrow-repeat"></i> Retake
          </a>
          {% endif %}
          {% comment %} <span class="badge-score">{{ attempt.score }} pts</span> {% endcomment %}
        </div>
        {% empty %}
        <p class="text-muted">No recent quizzes yet.</p>
        {% endfor %}
      </div>

      {% include "profileModal.html" %}
    </div>

    <!-- Leaderboard Modal -->
    <div
      class="modal fade"
      id="leaderboardModal"
      tabindex="-1"
      aria-labelledby="leaderboardModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header border-0">
            <h5 class="modal-title text-info fw-bold">
              <i class="bi bi-trophy me-2"></i> Top Scorers
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <table class="table table-dark table-hover align-middle">
              <thead>
                <tr class="text-info">
                  <th>#</th>
                  <th>Name</th>
                  <th>Total Score</th>
                </tr>
              </thead>
              <tbody>
                {% for user in leaderboard %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ user.name }}</td>
                  <td>{{ user.total_score }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    No leaderboard data yet.
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
